(define-data-var total-alerts uint u0)
(define-data-var total-monitored-contracts uint u0)
(define-data-var scanner-owner principal tx-sender)
(define-data-var emergency-pause bool false)
(define-data-var emergency-scan-override bool false)

(define-map contract-monitoring
  { contract-id: (buff 32) }
  {
    owner: principal,
    state-hash: (buff 32),
    last-scan-block: uint,
    alert-count: uint,
    is-active: bool,
    risk-level: (string-ascii 16),
    created-block: uint,
  }
)

(define-map alert-history
  { alert-id: uint }
  {
    contract-id: (buff 32),
    alert-type: (string-ascii 32),
    severity: (string-ascii 16),
    timestamp: uint,
    details: (string-ascii 256),
    resolved: bool,
  }
)

(define-map suspicious-patterns
  { pattern-id: uint }
  {
    pattern-name: (string-ascii 64),
    description: (string-ascii 256),
    risk-score: uint,
    is-active: bool,
  }
)

(define-map contract-state-snapshots
  {
    contract-id: (buff 32),
    snapshot-height: uint,
  }
  {
    state-hash: (buff 32),
    total-locked: uint,
    transaction-count: uint,
  }
)

(define-map whitelist
  { contract-id: (buff 32) }
  { is-whitelisted: bool }
)

(define-map user-subscriptions
  { user: principal }
  {
    is-subscribed: bool,
    alert-preference: (string-ascii 16),
    subscribed-contracts: uint,
  }
)

(define-constant ERR-NOT-OWNER (err u100))
(define-constant ERR-NOT-AUTHORIZED (err u101))
(define-constant ERR-CONTRACT-ALREADY-MONITORED (err u102))
(define-constant ERR-CONTRACT-NOT-FOUND (err u103))
(define-constant ERR-INVALID-RISK-LEVEL (err u104))
(define-constant ERR-PAUSED (err u105))
(define-constant ERR-PATTERN-NOT-FOUND (err u106))
(define-constant ERR-ALERT-NOT-FOUND (err u107))
(define-constant ERR-INVALID-SEVERITY (err u108))
(define-constant ERR-ALREADY-AUDITOR (err u109))
(define-constant ERR-NOT-AUDITOR (err u110))
(define-constant ERR-COOLDOWN-ACTIVE (err u114))

(define-constant SCAN-COOLDOWN u6) ;; ~1 hour

(define-map auditor-registry
  { auditor: principal }
  {
    is-authorized: bool,
    name: (string-ascii 64),
  }
)

(define-map contract-audits
  {
    contract-id: (buff 32),
    auditor: principal,
  }
  {
    report-hash: (buff 32),
    verdict: bool,
    timestamp: uint,
    notes: (string-ascii 128),
  }
)

(define-private (get-contract-hash (contract-id (buff 32)))
  (keccak256 contract-id)
)

(define-private (validate-risk-level (risk (string-ascii 16)))
  (or
    (is-eq risk "critical")
    (or
      (is-eq risk "high")
      (or
        (is-eq risk "medium")
        (is-eq risk "low")
      )
    )
  )
)

(define-private (validate-severity (severity (string-ascii 16)))
  (or
    (is-eq severity "critical")
    (or
      (is-eq severity "high")
      (or
        (is-eq severity "medium")
        (is-eq severity "low")
      )
    )
  )
)

(define-private (calculate-risk-score (pattern-id uint))
  (match (map-get? suspicious-patterns { pattern-id: pattern-id })
    existing (get risk-score existing)
    u0
  )
)

(define-public (register-contract
    (contract-id (buff 32))
    (risk-level (string-ascii 16))
  )
  (begin
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (asserts! (validate-risk-level risk-level) ERR-INVALID-RISK-LEVEL)
    (asserts!
      (is-none (map-get? contract-monitoring { contract-id: contract-id }))
      ERR-CONTRACT-ALREADY-MONITORED
    )
    (map-set contract-monitoring { contract-id: contract-id } {
      owner: tx-sender,
      state-hash: (get-contract-hash contract-id),
      last-scan-block: u0,
      alert-count: u0,
      is-active: true,
      risk-level: risk-level,
      created-block: stacks-block-height,
    })
    (var-set total-monitored-contracts (+ (var-get total-monitored-contracts) u1))
    (ok true)
  )
)

(define-public (remove-contract (contract-id (buff 32)))
  (let ((contract (unwrap! (map-get? contract-monitoring { contract-id: contract-id })
      ERR-CONTRACT-NOT-FOUND
    )))
    (begin
      (asserts! (is-eq tx-sender (get owner contract)) ERR-NOT-AUTHORIZED)
      (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
      (map-set contract-monitoring { contract-id: contract-id }
        (merge contract { is-active: false })
      )
      (ok true)
    )
  )
)

(define-public (create-alert
    (contract-id (buff 32))
    (alert-type (string-ascii 32))
    (severity (string-ascii 16))
    (details (string-ascii 256))
  )
  (let ((contract (unwrap! (map-get? contract-monitoring { contract-id: contract-id })
      ERR-CONTRACT-NOT-FOUND
    )))
    (begin
      (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
      (asserts! (validate-severity severity) ERR-INVALID-SEVERITY)
      (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
      (let ((alert-id (var-get total-alerts)))
        (begin
          (map-set alert-history { alert-id: alert-id } {
            contract-id: contract-id,
            alert-type: alert-type,
            severity: severity,
            timestamp: stacks-block-height,
            details: details,
            resolved: false,
          })
          (map-set contract-monitoring { contract-id: contract-id }
            (merge contract { alert-count: (+ (get alert-count contract) u1) })
          )
          (var-set total-alerts (+ alert-id u1))
          (ok alert-id)
        )
      )
    )
  )
)

(define-public (resolve-alert (alert-id uint))
  (let ((alert (unwrap! (map-get? alert-history { alert-id: alert-id }) ERR-ALERT-NOT-FOUND)))
    (begin
      (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
      (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
      (map-set alert-history { alert-id: alert-id }
        (merge alert { resolved: true })
      )
      (ok true)
    )
  )
)

(define-public (add-suspicious-pattern
    (pattern-id uint)
    (pattern-name (string-ascii 64))
    (description (string-ascii 256))
    (risk-score uint)
  )
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (asserts! (and (>= risk-score u1) (<= risk-score u100))
      ERR-INVALID-RISK-LEVEL
    )
    (map-set suspicious-patterns { pattern-id: pattern-id } {
      pattern-name: pattern-name,
      description: description,
      risk-score: risk-score,
      is-active: true,
    })
    (ok true)
  )
)

(define-public (disable-pattern (pattern-id uint))
  (let ((pattern (unwrap! (map-get? suspicious-patterns { pattern-id: pattern-id })
      ERR-PATTERN-NOT-FOUND
    )))
    (begin
      (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
      (map-set suspicious-patterns { pattern-id: pattern-id }
        (merge pattern { is-active: false })
      )
      (ok true)
    )
  )
)

(define-public (subscribe-to-alerts (alert-preference (string-ascii 16)))
  (begin
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (asserts! (validate-severity alert-preference) ERR-INVALID-SEVERITY)
    (match (map-get? user-subscriptions { user: tx-sender })
      existing (map-set user-subscriptions { user: tx-sender }
        (merge existing { alert-preference: alert-preference })
      )
      (map-set user-subscriptions { user: tx-sender } {
        is-subscribed: true,
        alert-preference: alert-preference,
        subscribed-contracts: u0,
      })
    )
    (ok true)
  )
)

(define-public (record-state-snapshot
    (contract-id (buff 32))
    (state-hash (buff 32))
    (total-locked uint)
    (transaction-count uint)
  )
  (let ((contract (unwrap! (map-get? contract-monitoring { contract-id: contract-id })
      ERR-CONTRACT-NOT-FOUND
    )))
    (begin
      (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
      (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
      (asserts! (or
        (var-get emergency-scan-override)
        (>= stacks-block-height (+ (get last-scan-block contract) SCAN-COOLDOWN))
      ) ERR-COOLDOWN-ACTIVE)
      (map-set contract-state-snapshots {
        contract-id: contract-id,
        snapshot-height: stacks-block-height,
      } {
        state-hash: state-hash,
        total-locked: total-locked,
        transaction-count: transaction-count,
      })
      (map-set contract-monitoring { contract-id: contract-id }
        (merge contract {
          state-hash: state-hash,
          last-scan-block: stacks-block-height,
        })
      )
      (ok true)
    )
  )
)

(define-public (whitelist-contract (contract-id (buff 32)))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (map-set whitelist { contract-id: contract-id } { is-whitelisted: true })
    (ok true)
  )
)

(define-public (remove-from-whitelist (contract-id (buff 32)))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (map-set whitelist { contract-id: contract-id } { is-whitelisted: false })
    (ok true)
  )
)

(define-public (toggle-emergency-pause (pause bool))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (var-set emergency-pause pause)
    (ok true)
  )
)

(define-public (transfer-ownership (new-owner principal))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (var-set scanner-owner new-owner)
    (ok true)
  )
)

(define-read-only (get-contract-info (contract-id (buff 32)))
  (ok (map-get? contract-monitoring { contract-id: contract-id }))
)

(define-read-only (get-alert-info (alert-id uint))
  (ok (map-get? alert-history { alert-id: alert-id }))
)

(define-read-only (get-pattern-info (pattern-id uint))
  (ok (map-get? suspicious-patterns { pattern-id: pattern-id }))
)

(define-read-only (get-snapshot
    (contract-id (buff 32))
    (target-stacks-block-height uint)
  )
  (ok (map-get? contract-state-snapshots {
    contract-id: contract-id,
    snapshot-height: target-stacks-block-height,
  }))
)

(define-read-only (get-whitelist-status (contract-id (buff 32)))
  (ok (map-get? whitelist { contract-id: contract-id }))
)

(define-read-only (get-subscription-info (user principal))
  (ok (map-get? user-subscriptions { user: user }))
)

(define-read-only (get-total-alerts)
  (ok (var-get total-alerts))
)

(define-read-only (get-total-monitored)
  (ok (var-get total-monitored-contracts))
)

(define-read-only (get-scanner-owner)
  (ok (var-get scanner-owner))
)

(define-read-only (get-emergency-pause-status)
  (ok (var-get emergency-pause))
)

;; Verified Auditor Registry Features

(define-public (authorize-auditor
    (auditor principal)
    (name (string-ascii 64))
  )
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (asserts! (is-none (map-get? auditor-registry { auditor: auditor }))
      ERR-ALREADY-AUDITOR
    )
    (map-set auditor-registry { auditor: auditor } {
      is-authorized: true,
      name: name,
    })
    (ok true)
  )
)

(define-public (revoke-auditor (auditor principal))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
    (map-set auditor-registry { auditor: auditor } {
      is-authorized: false,
      name: "",
    })
    (ok true)
  )
)

(define-public (submit-audit
    (contract-id (buff 32))
    (report-hash (buff 32))
    (verdict bool)
    (notes (string-ascii 128))
  )
  (let ((auditor-info (unwrap! (map-get? auditor-registry { auditor: tx-sender }) ERR-NOT-AUDITOR)))
    (begin
      (asserts! (not (var-get emergency-pause)) ERR-PAUSED)
      (asserts! (get is-authorized auditor-info) ERR-NOT-AUDITOR)
      (map-set contract-audits {
        contract-id: contract-id,
        auditor: tx-sender,
      } {
        report-hash: report-hash,
        verdict: verdict,
        timestamp: stacks-block-height,
        notes: notes,
      })
      (ok true)
    )
  )
)

(define-read-only (get-auditor-status (auditor principal))
  (ok (map-get? auditor-registry { auditor: auditor }))
)

(define-read-only (get-audit-report
    (contract-id (buff 32))
    (auditor principal)
  )
  (ok (map-get? contract-audits {
    contract-id: contract-id,
    auditor: auditor,
  }))
)
(define-read-only (get-remaining-cooldown (contract-id (buff 32)))
  (let ((contract (unwrap! (map-get? contract-monitoring { contract-id: contract-id }) ERR-CONTRACT-NOT-FOUND)))
    (ok (if (>= stacks-block-height (+ (get last-scan-block contract) SCAN-COOLDOWN))
      u0
      (- (+ (get last-scan-block contract) SCAN-COOLDOWN) stacks-block-height)
    ))
  )
)

(define-public (set-emergency-scan-override (override bool))
  (begin
    (asserts! (is-eq tx-sender (var-get scanner-owner)) ERR-NOT-AUTHORIZED)
    (var-set emergency-scan-override override)
    (ok true)
  )
)
